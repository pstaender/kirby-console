#!/usr/bin/env php
<?php

$kirbyBootstrap = getcwd() . '/kirby/bootstrap.php';
if (!file_exists($kirbyBootstrap )) {
    echo ("Couldn't find the kirby bootstrap file. Are you inside a valid kirby project? Missing file: $kirbyBootstrap \n");
    exit(1);
}

require getcwd() . '/kirby/bootstrap.php';

if (getcwd() !== realpath(__DIR__.'/../../../..')) {
    // this is the case if `kconsole` is used from global composer installation
    require __DIR__.'/../../../autoload.php';
}
if (file_exists(getcwd() . '/vendor/autoload.php')) {
    require getcwd() . '/vendor/autoload.php';
}

if (php_sapi_name() !== 'cli') {
    exit('This script can only be executed on cli');
}

$writeExitStatusToFile = '';
$displayStartupMessage = true;

$kirby = new Kirby();


// display help and exit?
foreach ($argv as $arg) {
    if ($arg === '-h' || $arg === '--help') {
        exit("Usage: ${argv[0]} (userEmail)\n");
    }
    if (str_starts_with($arg, '--write-exit-status-to-file=')) {
        $writeExitStatusToFile = explode('=', $arg)[1];
    }
    if ($arg === '--no-startup-message') {
        $displayStartupMessage = false;
    }
}

$startupMessage = "Kirby v" . kirby()->version();

$email = $argv[1] ?? '';
if (!empty($email) && ($email[0] !== '-')) {
    $kirby->impersonate($email);
    $startupMessage .= " â€“ " . kirby()->user()->email();
} else {
    $email = '';
}

Zeitpulse\KirbyInteractiveShell\Shell::shell([
    'startupMessage' => $displayStartupMessage ? $startupMessage : null,
], impersonate: $email, writeExitStatusToFile: $writeExitStatusToFile)->run();
